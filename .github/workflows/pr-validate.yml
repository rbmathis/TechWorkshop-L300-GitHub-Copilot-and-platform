name: Validate PR Commits

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    name: Validate Commit Messages
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages follow Conventional Commits
        run: |
          echo "## ðŸ“ Commit Message Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get commits in this PR
          commits=$(git log --pretty=format:"%H|%s" "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}")
          
          # Conventional Commits regex pattern
          # Matches: type(optional-scope): description
          # Also matches: type(scope)!: description for breaking changes
          pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9_-]+\))?(!)?:.{1,100}"
          
          invalid_count=0
          valid_count=0
          
          echo "Validating commits against Conventional Commits specification..." 
          echo ""
          
          while IFS='|' read -r hash message; do
            if [[ -z "$message" ]]; then
              continue
            fi
            
            # Skip merge commits
            if echo "$message" | grep -qE "^Merge (branch|pull request|remote-tracking branch)"; then
              echo "â„¹ï¸  Skipping merge commit: $message"
              continue
            fi
            
            # Check if commit message follows Conventional Commits
            if echo "$message" | grep -qE "$pattern"; then
              echo "âœ… Valid: $message"
              echo "- âœ… \`$message\`" >> $GITHUB_STEP_SUMMARY
              ((valid_count++))
            else
              echo "âŒ Invalid: $message"
              echo "- âŒ \`$message\` - Does not follow Conventional Commits format" >> $GITHUB_STEP_SUMMARY
              ((invalid_count++))
            fi
          done <<< "$commits"
          
          echo ""
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $invalid_count -gt 0 ]; then
            echo "**Result:** âŒ $invalid_count invalid commit message(s) found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Required Format" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo 'type(scope): description' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Valid types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Examples:**" >> $GITHUB_STEP_SUMMARY
            echo '- `feat: add new shopping cart feature`' >> $GITHUB_STEP_SUMMARY
            echo '- `fix: resolve checkout validation issue`' >> $GITHUB_STEP_SUMMARY
            echo '- `feat(cart)!: breaking change to cart API`' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“– See [CONTRIBUTING.md](CONTRIBUTING.md) for complete guidelines." >> $GITHUB_STEP_SUMMARY
            
            echo ""
            echo "âŒ Validation failed: $invalid_count invalid commit message(s)"
            echo "Please update commit messages to follow Conventional Commits format"
            echo "See CONTRIBUTING.md for guidelines"
            exit 1
          else
            echo "**Result:** âœ… All commit messages are valid ($valid_count commits checked)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Great job following the Conventional Commits specification! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "âœ… All $valid_count commit messages are valid"
          fi

      - name: Detect version bump type
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Automatic Versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          commits=$(git log --pretty=format:"%s" "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}")
          
          # Define regex patterns (matching bump-version.sh)
          BREAKING_CHANGE_PATTERN="BREAKING[- ]CHANGE:|^[a-zA-Z]+(\([^)]+\))?!:"
          FEATURE_PATTERN="^feat(\([^)]+\))?:"
          
          bump_type="patch"
          reasons=()
          
          while IFS= read -r message; do
            # Skip merge commits
            if echo "$message" | grep -qE "^Merge (branch|pull request|remote-tracking branch)"; then
              continue
            fi
            
            # Check for breaking changes
            if echo "$message" | grep -qiE "$BREAKING_CHANGE_PATTERN"; then
              bump_type="major"
              reasons+=("- ðŸ”´ **MAJOR** bump: Breaking change detected in: \`$message\`")
            # Check for features
            elif echo "$message" | grep -qiE "$FEATURE_PATTERN"; then
              if [[ "$bump_type" != "major" ]]; then
                bump_type="minor"
                reasons+=("- ðŸŸ¡ **MINOR** bump: New feature in: \`$message\`")
              fi
            fi
          done <<< "$commits"
          
          echo "**Detected version bump:** \`$bump_type\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ${#reasons[@]} -gt 0 ]; then
            echo "**Reasoning:**" >> $GITHUB_STEP_SUMMARY
            for reason in "${reasons[@]}"; do
              echo "$reason" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- ðŸŸ¢ **PATCH** bump: No breaking changes or new features detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version will be automatically updated when this PR is merged. âœ¨" >> $GITHUB_STEP_SUMMARY
